---
- hosts: localhost
  connection: local
  become: true

  vars_files: 
    - main.yml

  tasks:

  - name: Check if files / folders exist and are symlinks.
    stat:
      path: "/home/{{ username }}/{{ item }}"
    register: symlink_check
    with_items: "{{ dot_files }}"

  - name: Delete any file or folder that is not a symlink.
    file:
      path: "{{ item.stat.path }}"
      state: absent
    when: item.stat.islnk is false 
    with_items: "{{ symlink_check.results }}"

  - name: check if the .local folder already exist.
    stat:
      path: "/home/{{ username }}/.local"
    loop: "{{ folders }}"
    register: git_exist


  - name: Create the .local folder if it doesn't exist.
    file:
      path: "/home/{{ username }}/.local"
      state: directory 
      owner: "{{ username }}"
      group: "{{ username }}"
      mode: 0755
    when: git_exist.stat.exists is false

  - name: Install ssh private key.
    copy: 
      src: id_github
      dest: "/home/{{ username }}/.ssh/id_rsa"
      owner: "{{ username }}"
      group: "{{ username }}" 
      mode: 0600

  - name: git pull the repo to get the submodules.
    git:
      repo: git@github.com:BladeWDR/dotfiles.git
      dest: "/home/{{ username }}/git/dotfiles"
      accept_newhostkey: true
    become_user: "{{ username }}" 

  - name: Run dotbot setup script.
    shell: "/home/{{ username }}/git/dotfiles/install"
    become_user: "{{ username }}"
